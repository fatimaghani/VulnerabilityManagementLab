# Azure Vulnerability Management Lab: Assessing and Remediating Security Risks with OpenVAS

## Introduction:
In this lab, I will go through the process of setting up a vulnerability management environment in Azure. I look to learn how to configure and utilize OpenVAS, a vulnerability scanner, to identify and assess security vulnerabilities in a Windows virtual machine (VM). Additionally, I will perform uncredentialed scans, and credentialed scans, apply remediations, and verify the effectiveness of the remediation measures.

## Prerequisites:
- Azure Account with access to Azure Portal

<details> 
  
<summary>
  
### Task 1: Prepare the Vulnerability Management Scanner
  
</summary>

First, we set up our Vulnerability Management Scanner by installing OpenVAS from the Azure marketplace. We use a weak pre-set configuration for our virtual machine (VM) and SSH into it, patiently waiting for the OpenVAS to deploy.
  
- Go to the Azure Portal and navigate to the Marketplace.
- Search for "OpenVAS secured and supported by HOSSTED" and select it.
- Choose a pre-set configuration and create the VM with specified settings.

- Virtual Machine Settings

| Setting | Value|
|---|---|
| Resource Group:| Vulnerability-Management|
| VM Name:| OpenVAS (Take note of the region and Vnet–consider East US )|
| Region: | East US (`make sure to note the region and Vnet`)|
| Authentication: | Password (Provide Username/Password)|
- On the Disk Tab, Networking, Management, and Advanced we will let them remain as their default Settings.
- For the Monitoring tab, we will disable boot diagnostics as it will not be needed in the lab.

<p align="center"><img src="https://i.imgur.com/WcEB4J0.png" height="80%" width="80%" alt="Create Virtual Machine"/></p>

Now we will connect to the OpenVAS VM via SSH using PowerShell (Windows) or Terminal (MacOS).
Wait until the OpenVAS deployment completes and access the web app URL (For this example: `https://104.208.154.83.c.hossted.com/`)

<p align="center"><img src="https://i.imgur.com/HKRFN0y.png" height="80%" width="80%" alt="Terminal"/></p>
<p align="center"><img src="https://i.imgur.com/GiaCovT.png" height="80%" width="80%" alt="Terminal 2"/></p>

- Log in with provided credentials or try admin/admin if needed (admin/admin was used below) and then immediately change the password for security purposes. To do so, we can click on the person icon at the top right of the page, then select the pencil/note icon near the top left of the page. You will then be shown a pop-up to make the change of the old password to the new password. 
  <br />
<p align="center"><img src="https://i.imgur.com/68M11KR.png" height="80%" width="80%" alt="Greenbone"/></p>

</details>

#

<details>
  
<summary>
  
### Task 2:Create a Client Virtual Machine and Make it Vulnerable

</summary>

- Create a new Virtual Machine in Azure Portal, following specified settings
  
| Setting | Value|
|---|---|
| Resource Group:| Vulnerability-Management (Same as Previous)|
| VM Name:| Win10-Vulnerable|
| Region: | Same as the OpenVAS VM (East US)|
| Virtual Network: | Same as OpenVAS (this is important)|
| Image: | Windows 10 Pro|
| Size: | Any size with min 2 vCPUs|
| Username/Password: | azureuser/Cyberlab123!|
| Networking: | Same Vnet as OpenVAS|

- The other tabs that of this VM are left as default
<p align="left"><img src="https://i.imgur.com/0pxU5PR.png" height="80%" width="80%" alt="VM 2"/></p>

Now we will log into he VM using RDP and disable the Windows Firewall and install [outdated software](https://drive.google.com/drive/folders/1n83ilCjZWZulbDdYnUe9wQPK2buY47_U) (be sure that these tasks are completed inside the virtual machine).

1. Log into VM using RDP <p align="left"><img src="https://i.imgur.com/2Y3v5xC.png" height="60%" width="60%" alt="RDP"/></p>
2. Disable Windows Firewall <p align="left"><img src="https://i.imgur.com/Qpq88PR.png" height="60%" width="60%" alt="Firewall Settings VM"/></p>
3. Download the outdated software <p align="left"><img src="https://i.imgur.com/nUSG7GG.png" height="50%" width="50%" alt="Outdated Software"/></p>

4. Restart the VM.

</details>

#

<details>
  
<summary> 
  
### Task 3: Configure OpenVAS for Unauthenticated Scan against Vulnerable VM

</summary>

Once our vulnerable VM is ready, we configure OpenVAS to perform our first unauthenticated scan against it. We create a new target, host, and task for this process. The scan gives us insights into the VM's vulnerabilities. 

- Log in to OpenVAS and add the Client VM's (Win-10 Vulnerable) private IP address as a new host.
- Hover over Assets → Host → New Host Icon at the top left.
  <p align="left"><img src="https://i.imgur.com/hm5wWXM.png" height="80%" width="80%" alt="New Host"/></p>
- Create a new target named "Azure Vulnerable VMs" using the host information.
  <p align="left"><img src="https://i.imgur.com/hjQQbwy.png" height="80%" width="80%" alt="New Target"/></p>

- Create a new task named "Scan - Azure Vulnerable VMs" with the target.
  - Hover over Scans → Task → New Task Icon at the top left
  - Scan Targets → “Azure Vulnerable VMs” (This is the target that we created previously)
<p align="left"><img src="https://i.imgur.com/Zff4t3e.png" height="80%" width="80%" alt="New Task"/></p>

- Start the scan by pressing the ▶️ and review the results once it's completed.
  - The status will change from Requested  → Queued →  Percentage Loaded → Done
  - When the status is Done and you can select the report to review the vulnerabilities for the uncredentialed scan. 
<p align="left"><img src="https://i.imgur.com/hIVS8VB.png" height="80%" width="80%" alt="Uncredentialed Scan"/></p>

To remove the filtered results of the report, you can select the `X` near the top of the page and it will display more vulnerabilities. Once the filter is removed here, it will display those that include a `0.0` as their severity level as well. 
<p align="left"><img src="https://i.imgur.com/srFjUDK.png" height="80%" width="80%" alt="Uncredentialed Scan Report"/></p>

</details>

#

<details>
  
<summary>
  
  ### Task 4: Configure Credentialed Scans within VM and OpenVAS

</summary>

Now we start preparations for credentialed scans. This involves making configurations within our VM like disabling the Windows Firewall and User Account Control, enabling Remote Registry, and setting a specific Registry Key. Similarly, configurations for credentialed scans are also made within OpenVAS.

Make necessary configurations within the vulnerable VM (Windows settings).
- Disable Firewall (done previously)
- Disable User Account Control
  - <p align="left"><img src="https://i.imgur.com/Tf0GlPe.png" height="80%" width="80%" alt="User Account Control"/></p>
- Enable Remote Registry. Do a quick search for `Services.msc` at the bottom left of the Windows machine.
  - <p align="left"><img src="https://i.imgur.com/wMQ3wlA.png" height="80%" width="80%" alt="Remote Registry"/></p>
- Scroll down to Remote Registry  → Double click (to select)  → Startup Type set to `Automatic` → Start → Apply → OK.
- Set Registry Key
- Launch Registry Editor (regedit.exe) in “Run as administrator” mode and grant Admin Approval, if requested
- Navigate to HKEY_LOCAL_MACHINE hive
- Open SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System key
- Create a new DWORD (32-bit) value with the following properties:
  - <p align="left"><img src="https://i.imgur.com/Nf7ODYg.png" height="80%" width="80%" alt="Remote Registry"/></p>
- Name: LocalAccountTokenFilterPolicy
   - After DWORD (32-bit) is selected you will add `LocalAccountTokenFilterPolicy` without any spaces added.  
   - Double click → LocalAccountTokenFilterPolicy → Change Value from 0 to 1 → OK
 - Close Registry Editor
 - Restart the VM

Then, we make corresponding configurations in OpenVAS for credentialed scans.
  - Go to Configuration → Credentials → New Credential
  - Name / Comment → “Azure VM Credentials”
    
| Settings | Value |
|----|----|
|Allow Insecure Use: | Yes|
| Username: | azureuser |
| Password: | password (same password as vulnerable VM)|

<p align="left"><img src="https://i.imgur.com/yDqgmuG.png" height="80%" width="80%" alt="New Credential"/></p>

- Go to Configuration → Targets → CLONE the Target we made before
  - NEW Name / Comment: “Azure Vulnerable VMs - Credentialed Scan”
  - Ensure the Private IP is still accurate
  - Credentials → SMB → Select the Credentials we just made: Azure VM Credentials
<p align="left"><img src="https://i.imgur.com/xIyDVL3.png" height="80%" width="80%" alt="Clone Target"/></p>

</details>

#

<details>
 <summary> 
   
### Task 5: Execute Credentialed Scan against Vulnerable VM

</summary>

After we create new credentials and clone the previous target, we execute the credentialed scan against our vulnerable VM using the newly created credentials. This scan takes longer than the previous one, but provides a more in-depth analysis of vulnerabilities.

Clone the previous scan task and edit it for credentialed scanning.
- CLONE the “Scan - Azure Vulnerable VMs” Task, then Edit it:
- Name / Comment → “Scan - Azure Vulnerable VMs - Credentialed”
- Targets: Azure Vulnerable VMs - Credentialed Scan
<p align="left"><img src="https://i.imgur.com/hLc5n4P.png" height="80%" width="80%" alt="Clone Scan"/></p>

- Once saved, click the ▶️ button to launch the new Credentialed Scan, and wait for it to finish

Observe the differences in findings compared to the unauthenticated scan.
<p align="left"><img src="https://i.imgur.com/ZhkIKkg.png" height="80%" width="80%" alt="Credentialed Scan"/></p>

Results of the credentialed scan
<p align="left"><img src="https://i.imgur.com/mawTRX1.png" height="80%" width="80%" alt="Credentialed Scan Results"/></p>


</details>

#

<details>

<summary>
  
### Task 6: Remediate Vulnerabilities

</summary>

Once we've identified the vulnerabilities, we remediate them by uninstalling the outdated software and restarting the VM.

Log back into the Win10-Vulnerable VM and uninstall outdated software.
- Search Control Panel → Uninstall Programs → Select Each Outdated of the Programs (VLC media player 1.1.7, Mozilla Firefox (x64 en-US), Adobe Reader X)
<p align="left"><img src="https://i.imgur.com/uU6Ibqw.png" height="80%" width="80%" alt="Uninstall Outdated Software"/></p>
Restart the VM to apply the changes.
</details>

#

<details>

<summary>
    
### Task 7: Verify Remediations

</summary>

Finally, we verify our remediations by re-initiating the credentialed scan and observing the results.

Re-initiate the credentialed scan (“Scan - Azure Vulnerable VMs - Credentialed") and observe the updated results.
 >**Note**: In the trend column, we can notice that there is a downward trend now that we have removed the outdated programs.
<p align="left"><img src="https://i.imgur.com/PDTGxdM.png" height="80%" width="80%" alt="Rerun Credentialed Scan"/></p>
<p align="left"><img src="https://i.imgur.com/PTWjXZw.png" height="80%" width="80%" alt="Repeated Credentialed Scan Report"/></p>

The vulnerabilities for FireFox, VLC Player, or Adobe Reader are no longer present. Additionally, we can drill down into the results of the report to view the impact of the vulnerabilities that are remaining and the available solutions.
<p align="left"><img src="https://i.imgur.com/NOkPb6m.png" height="80%" width="80%" alt="Repeated Credentialed Scan Report"/></p>

`That's that end of the lab, be sure to delete the resource group that was created if you are done and it no longer has use.`

</details>

## Reflection:
This lab provided hands-on experience in setting up and using a vulnerability management scanner with Azure and OpenVAS. It highlighted the importance of proactive vulnerability management and the impact of misconfigurations and outdated software on system security.

Configuring OpenVAS for unauthenticated scans and performing the scans allowed me to identify vulnerabilities and understand the need for regular scanning to detect security risks.

Implementing credentialed scans and comparing the results with unauthenticated scans demonstrated the value of using proper credentials for accurate vulnerability identification.

Remediating vulnerabilities by uninstalling outdated software and verifying the changes through subsequent scans reinforced the importance of timely actions to reduce the attack surface.

## Conclusion:
This lab enhanced my understanding of vulnerability management and the continuous effort required for maintaining a secure environment. It emphasized the significance of proactive security practices, timely remediation, and the value of comprehensive scanning approaches.

I now possess practical knowledge and skills in vulnerability management using Azure and OpenVAS, ready to apply them in real-world scenarios and contribute to effective system protection.
